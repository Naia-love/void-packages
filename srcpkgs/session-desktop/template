# Template file for 'session-desktop'
pkgname=session-desktop
version=1.6.9
revision=1
# discontinued Electron 32-bit support: https://www.electronjs.org/blog/linux-32bit-support
# aarch64 dosen't seems very stable for now and isn't officialy supported: https://github.com/oxen-io/session-desktop/issues/1635
archs="x86_64"
hostmakedepends="curl nodejs python yarn git git-lfs tar ImageMagick"
depends="cairo gtk+3 libvips pango alsa-lib nss libXtst dbus-libs libnotify"
short_desc="Session is an end-to-end encrypted messenger"
maintainer="Naia-love <me@naia.gay>"
license="GPL-3.0-or-later"
homepage="https://getsession.org"
distfiles="https://github.com/oxen-io/${pkgname}/archive/refs/tags/v${version}.tar.gz"
checksum=4abf94eb2233a19687c9d87a7644d51eb7199ae0f04deba9647cbe4c7c0a3afa


pre_build() {
	# fix for systray 
	for size in 16 32 48 128 256 480 512 1024; do
		convert -size ${size}x${size} -background none images/session/session_icon.svg images/session/session_icon_${size}.png
	done

	git lfs install
	yarn install --frozen-lockfile --arch=x64

	sed -i 's/"updatesEnabled": true/"updatesEnabled": false/' config/production.json # disable updates's notification
}

do_build() {
	yarn generate
	yarn build-release
}

do_install() {
	vmkdir usr/lib/session-desktop

	vcopy release/linux-unpacked/* usr/lib/session-desktop

	vmkdir usr/bin
	ln -s /usr/lib/session-desktop/session-desktop ${DESTDIR}/usr/bin/session
	ln -s /usr/lib/session-desktop/session-desktop-bin ${DESTDIR}/usr/bin/

	vmkdir usr/share/applications
	vinstall ${FILESDIR}/session.desktop 644 usr/share/applications/

	vmkdir usr/share/icons/hicolor

	for size in 16 32 48 128 256 480 512 1024; do
		vinstall images/session/session_icon_${size}.png 644 usr/share/icons/hicolor/${size}x${size}/apps/ session.png
	done
	vinstall images/session/session_icon.svg 644 usr/share/icons/hicolor/scalable/apps/ session.svg
}
